<!DOCTYPE html>
<html>

<head>
  <title>Tile Engine</title>
  <style>
    * {
      margin: 0;
      border: 0;
    }

    body {
      background-color: black;
    }

    div#float {
      color: white;
      float: right;
      margin: 40px;
      font-size: 25px;
    }

    canvas {
      background: black;
      width: 1100px;
      height: 600px;

    }

    button {
      background-color: #4CAF50;
      /* Green */
      border: none;
      padding: 15px 32px;
      text-align: center;
      margin-top: 20px;
      cursor: pointer;
    }
    .name {
      margin-top: 5px;
      margin-bottom: 5px;
    }

    .c{
      font-size: 20px;
      color: white;
    }
    .ins {
      position: fixed;
      right: 40px;
      padding : 20px;
      border: white solid 2px;
      bottom :40px;
    }

  </style>
  <script type="text/javascript" src="kontra.js"></script>
</head>

<body>

  <div class="name">Adventure Time: Chapter Save Princess</div>
  <canvas width="352" height="176"></canvas>
  <!-- <canvas width="1600" height="800px"></canvas> -->

  <div id="float">
    <div class="c">Score:
      <span id="score">0</span>
    </div>
    <button id="button" class="c" style="display:none" onclick="startGame()">Restart</button>
    <div id="state">Game Started</div>
  </div>
  <div class="ins c">Instructions --<br> Mute: m <br> Arrow: Navigate</div>
  <script id="code">
    kontra.init();
    var playscore = 0, stag = document.getElementById('score'), button = document.getElementById('button'), state = document.getElementById('state');


    kontra.assets.imagePath = 'assets/';
    kontra.assets.dataPath = 'assets/';
    function startGame() {
      location.reload();
    };
    setTimeout(function () {
      state.innerHTML = "";
      document.getElementById('button').style.display = "inline-block";
    }, 2000);

    kontra.assets.load('terrain.json', 'man.png', 'new.png').then(function () {
      var terrain = kontra.assets.data.terrain;
      var quadtree = kontra.quadtree();
      tileEngine = kontra.tileEngine(kontra.assets.data.terrain);
      tileEngine.sx = 0,
        tileEngine.sy = 0

      var tsure = kontra.pool({
        create: kontra.sprite,
        maxSize: 75
      });
      var tsure_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gold: {
            frames: [90],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gems: {
            frames: [91],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnTsure() {
        var arry = [16, 32, 32, 32, 64, 64, 64, 80, 80, 80, 112, 128, 128, 128, 128, 144, 144, 144, 160, 160, 208, 224, 224, 240, 256, 256, 352, 368, 368, 400, 448, 448, 464, 480, 480, 496, 496, 496, 496, 496, 528, 544, 544, 576, 576, 592, 688, 688, 704, 704, 704, 720, 720, 736, 736, 752, 752, 0, 0, 16, 16, 320, 320, 512, 528, 528, 544, 560, 608, 624, 656, 672, 672, 720, 768];
        var arrx = [416, 352, 368, 448, 64, 80, 96, 64, 80, 96, 1152, 496, 512, 528, 1168, 512, 528, 1152, 528, 1168, 336, 304, 384, 352, 304, 368, 1120, 1008, 1040, 1104, 1008, 1072, 976, 1040, 1056, 608, 688, 1024, 1072, 1088, 640, 608, 672, 608, 640, 672, 944, 1024, 336, 416, 976, 400, 1008, 368, 960, 960, 992, 752, 784, 736, 768, 1424, 1440, 1552, 512, 1568, 1568, 1552, 1440, 1424, 1552, 1488, 1504, 1536, 1536];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          var type = ['gold', 'gems'];
          var type = type[Math.floor(Math.random() * 2)]
          tsure.get(function (types) {
            return {
              x: x,
              y: y,
              startX: x,
              startY: y,
              animations: tsure_animation.animations,
              ttl: Infinity,
              type: types,
              way: 1,
              update: function () {
                if (this.way == 1) {
                  this.playAnimation(types)
                  this.way = 0
                }
                this.x = this.startX - tileEngine.sx;
                this.y = this.startY - tileEngine.sy;
              }
            }
          }(type));
        }
      }
      spawnTsure();

      var Switch = kontra.pool({
        create: kontra.sprite,
        maxSize: 3
      });
      var switch_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gate_open: {
            frames: [100, 101, 102],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gate_close: {
            frames: [102, 101, 100],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          no_motion: {
            frames: [100],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnswitch() {
        var arry = [128, 144, 736];
        var arrx = [112, 432, 1520];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          Switch.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: switch_animation.animations,
            ttl: Infinity,
            count: 30,
            way: 1,
            start: 1,
            type: 'switch',
            toggle: function () {
              if (this.way) {
                this.playAnimation('gate_open')
                this.way = 0
              } else {
                this.playAnimation('gate_close')
                this.way = 1
              }
            },
            update: function () {
              this.advance();
              if (this.start) {
                this.playAnimation('no_motion')
                this.start = 0
              }
              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnswitch();

      var sgate = kontra.pool({
        create: kontra.sprite,
        maxSize: 3
      });

      var sgate_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gate_open: {
            frames: [48, 93, 9, 59],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gate_close: {
            frames: [59, 9, 93, 48],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          no_motion: {
            frames: [48],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnsGate() {
        var arry = [112, 592, 80];
        var arrx = [80, 1072, 400];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          sgate.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            way: 1,
            start: 1,
            animations: sgate_animation.animations,
            ttl: Infinity,
            type: 'gate',
            toggle: function () {
              if (this.way) {
                this.playAnimation('gate_open')
                this.way = 0
              } else {
                this.playAnimation('gate_close')
                this.way = 1
              }
            },
            update: function () {
              this.advance();
              if (this.start) {
                this.playAnimation('no_motion')
                this.start = 0
              }
              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnsGate();

      var lamps = kontra.pool({
        create: kontra.sprite,
        maxSize: 49
      });

      var lamp_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          default: {
            frames: [107, 108, 109],  // frames 105 through 112
            frameRate: 6
          }, routing : {
            frames: [15],  // frames 105 through 112
            frameRate: 6
          }
        }
      });

      function spawnLamp() {
        var arry = [48, 48, 96, 96, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 352, 352, 352, 368, 384, 384, 400, 416, 416, 416, 416, 432, 432, 448, 448, 464, 464, 480, 480, 496, 496, 512, 512, 528, 528, 544, 544, 544, 544, 544, 544, 544, 544];
        var arrx = [48, 112, 48, 112, 976, 992, 1008, 1024, 1040, 1056, 1072, 1088, 1104, 1120, 1136, 1152, 960, 976, 1152, 960, 960, 1152, 1152, 960, 1120, 1136, 1152, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 976, 992, 1008, 1024, 1040, 1104, 1120];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          lamps.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: lamp_animation.animations,
            ttl: Infinity,
            type: 'lamp',
            update: function () {
              this.advance();

              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnLamp();

      var traps = kontra.pool({
        create: kontra.sprite,
        maxSize: 30
      });

      var trap_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          pattern1: {
            frames: [103, 104, 105],  // frames 105 through 112
            frameRate: 2
          },
          pattern0: {
            frames: [104, 105, 103],  // frames 105 through 112
            frameRate: 2
          }
        }
      });

      function spawnTrap() {
        var arry = [112, 112, 128, 128, 144, 144, 352, 352, 368, 368, 384, 384, 560, 560, 560, 576, 576, 576, 576, 592, 592, 592, 592, 592, 640, 640, 640, 640, 656, 672];
        var arrx = [448, 704, 448, 704, 448, 704, 1280, 1360, 1280, 1360, 1280, 1360, 1024, 1040, 1120, 1040, 1104, 1120, 1488, 1040, 1056, 1088, 1104, 1488, 368, 384, 400, 1296, 1296, 1296];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          traps.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: trap_animation.animations,
            ttl: Infinity,
            type: 'trap',
            update: function () {
              this.advance();
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnTrap();

      var spider = kontra.pool({
        create: kontra.sprite,
        maxSize: 5
      });


      var spider_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_down: {
            frames: [61, 62, 63],  // frames 105 through 112
            frameRate: 12
          },
          walk_right: {
            frames: [46, 47, 49],
            frameRate: 12
          },
          walk_left: {
            frames: [17, 27, 37],
            frameRate: 12
          },
          walk_up: {
            frames: [81, 82, 83],
            frameRate: 12
          }
        }
      });

      function spawnSpider() {
        var arrY = [512, 576, 704, 768, 768];
        var arrX = [304, 416, 768, 688, 800];
        for (var i in arrX) {
          var x = arrX[i], y = arrY[i];
          spider.get({
            x: x,
            y: y,
            Y: 0,
            startX: x,
            startY: y,
            animations: spider_animation.animations,
            ttl: Infinity,
            bottomEdge: 32 + 16,
            topEdge: -32,
            speedy: .5,
            type: 'ghost',
            update: function () {
              this.advance();
              this.Y += this.speedy;
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY + this.Y - tileEngine.sy;
              if (this.Y <= this.topEdge) {
                this.speedy = Math.abs(this.speedy);
              }
              else if (this.Y >= this.bottomEdge) {
                this.speedy = -Math.abs(this.speedy);
              }
              if (this.speedy > 0) {
                this.playAnimation('walk_down')
              } else if (this.speedy < 0) {
                this.playAnimation('walk_up')
              }
            },
          });
        }
      }
      spawnSpider();

      var ghosts = kontra.pool({
        create: kontra.sprite,
        maxSize: 16
      });


      var ghost_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_up: {
            frames: [80, 77, 67],  // frames 105 through 112
            frameRate: 12
          },
          walk_left: {
            frames: [16, 26, 36],
            frameRate: 12
          },
          walk_down: {
            frames: [60, 55, 45],
            frameRate: 12
          },
          walk_right: {
            frames: [7, 0, 75],
            frameRate: 12
          }
        }
      });

      function spawnGhost() {
        var arry = [160, 192, 208, 224, 320, 368];
        var arrx = [384, 1424, 80, 1168, 288, 80];
        var arrY = [400, 496, 496, 512, 512, 560, 560, 560, 672, 720];
        var arrX = [32, 800, 832, 240, 448, 272, 784, 816, 1120, 896];

        // var funarr = [horver,]
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          ghosts.get({
            x: x,
            y: y,
            X: 0,
            startX: x,
            startY: y,
            animations: ghost_animation.animations,
            ttl: Infinity,
            leftEdge: -32,
            rightEdge: 32 + 16,
            speedx: .5,
            type: 'ghost',
            update: function () {
              this.advance();

              this.X += this.speedx;
              this.x = this.startX + this.X - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
              if (this.X <= this.leftEdge) {
                this.speedx = Math.abs(this.speedx);
              }
              else if (this.X >= this.rightEdge) {
                this.speedx = -Math.abs(this.speedx);
              }
              if (this.speedx > 0) {
                this.playAnimation('walk_right')
              } else if (this.speedx < 0) {
                this.playAnimation('walk_left')
              }
            },
          });
        }
        for (var i in arrX) {
          var x = arrX[i], y = arrY[i];
          ghosts.get({
            x: x,
            y: y,
            Y: 0,
            startX: x,
            startY: y,
            animations: ghost_animation.animations,
            ttl: Infinity,
            bottomEdge: 32 + 16,
            topEdge: -32,
            speedy: .5,
            type: 'ghost',
            update: function () {
              this.advance();
              this.Y += this.speedy;
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY + this.Y - tileEngine.sy;
              if (this.Y <= this.topEdge) {
                this.speedy = Math.abs(this.speedy);
              }
              else if (this.Y >= this.bottomEdge) {
                this.speedy = -Math.abs(this.speedy);
              }
              if (this.speedy > 0) {
                this.playAnimation('walk_down')
              } else if (this.speedy < 0) {
                this.playAnimation('walk_up')
              }
            },
          });
        }
      }


      // create the walking man sprite sheet and animations
      var routes = kontra.pool({
        create: kontra.sprite,
        maxSize: 4
      });

      function spawnRoutes() {
        var arry = [368, 400, 720,112];
        var arrx = [1152, 960, 1488,1424];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          routes.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            way:1,
            ttl: Infinity,
            type: 'route',
            animations: lamp_animation.animations,
            update: function () {
              // this.advance();
              if(this.way){
                this.playAnimation('routing');
                this.way=0;
              }
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            }
          });
        }
      }
      spawnRoutes();

      var princess = kontra.pool({
        create: kontra.sprite,
        maxSize: 1
      });

      var player_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_up: {
            frames: [44, 34, 24],  // frames 105 through 112
            frameRate: 12
          },
          walk_left: {
            frames: [2, 12, 22],
            frameRate: 12
          },
          walk_down: {
            frames: [10, 76, 1],
            frameRate: 12
          },
          walk_right: {
            frames: [33, 40, 41],
            frameRate: 12
          },
          dead: {
            frames: [11],
            frameRate: 12
          },
          princess: {
            frames: [10,1],
            frameRate: 3
          }
        }
      });

        princess.get({
            x: 1072,
            y: 354,
            startX: 1072,
            startY: 384,
            time: 0,
            animations: player_animation.animations,
            ttl: Infinity,
            type: 'princess',
            update: function () {
              this.advance();
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
              if(this.time == 0){
                this.playAnimation('princess')
                this.time = 60
              }
              else {
                this.time--
              }
            }
          });
      player = kontra.sprite({
        x: 176,
        y: 88,
        speed: 1,
        startX: 176,
        startY: 88,
        animations: player_animation.animations,
        update: function () {
          // create a smaller bounding box for the player's collision
          var collisionBox = {
            y: this.y + 4,
            x: this.x + 2,
            width: 10,
            height: 10
          };

          if (kontra.keys.pressed('up')) {
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }
            this.playAnimation('walk_up');
            this.advance();
            collisionBox.y -= this.speed;
            if (tileEngine.sy > 0 && this.y <= this.startY) {
              tileEngine.sy -= this.speed;
            }
            else {
              this.y -= this.speed;
            }
          }

          else if (kontra.keys.pressed('down')) {
            this.playAnimation('walk_down');

            this.advance();

            collisionBox.y += this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }
            if (tileEngine.sy < tileEngine.mapHeight - kontra.canvas.height &&
              this.y >= this.startY) {
              tileEngine.sy += this.speed;
            }
            else {
              this.y += this.speed;
            }
          }

          else if (kontra.keys.pressed('left')) {
            this.playAnimation('walk_left');

            this.advance();

            collisionBox.x -= this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }

            if (tileEngine.sx > 0 && this.x <= this.startX) {
              tileEngine.sx -= this.speed;
            }
            else {
              this.x -= this.speed;
            }
          }

          else if (kontra.keys.pressed('right')) {
            this.playAnimation('walk_right');

            this.advance();

            collisionBox.x += this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }

            if (tileEngine.sx < tileEngine.mapWidth - kontra.canvas.width &&
              this.x >= this.startX) {
              tileEngine.sx += this.speed;
            }
            else {
              this.x += this.speed;
            }
          }
        },
      });
      const context = new AudioContext();
      function NotesGenerator() {
        this.playNote = function(v) {
          const oscillator = context.createOscillator();

          const waveForm = Math.random() > 0.5 ? "sine" : "triangle";
          oscillator.type = waveForm;
          oscillator.frequency.value = v;

          const gainNode = context.createGain();
          gainNode.gain.value = 0.2;

          // generate sound
          oscillator.connect(gainNode);
          gainNode.connect(context.destination);

          oscillator.start(0);

          const duration = 2.5;

          gainNode.gain.linearRampToValueAtTime(
            0.0001,
            context.currentTime + duration
          );
          oscillator.stop(context.currentTime + duration);
        };

      }

      // clamp player position in the game world
      player.position.clamp(0, 0, kontra.canvas.width - player.width, kontra.canvas.height - player.height);

      let notesGenerator = new NotesGenerator(), frames = 60, v=0, muted = 0 ;
      var nextNote = [196,65.5,496,588,880,440,588,98,165,660,392,330,165,392,123.5,524,349];

      var loop = kontra.gameLoop({
        update: function () {
          ghosts.update();
          lamps.update();
          traps.update();
          Switch.update();
          sgate.update();
          tsure.update();
          spider.update();
          princess.update();
          routes.update();

          if (ghosts.getAliveObjects().length === 0) {
            spawnGhost();
          }
          quadtree.clear();
          quadtree.add(Switch.getAliveObjects(), princess.getAliveObjects(),sgate.getAliveObjects(), tsure.getAliveObjects(), ghosts.getAliveObjects(), spider.getAliveObjects(), traps.getAliveObjects(), routes.getAliveObjects());
          var objects = quadtree.get(player);

          for (var i = 0, obj; obj = objects[i]; i++) {
            if (obj.type === 'route' && obj.collidesWith(player)){
              var blocksize = 20, sign =1,x,y,dx = 112,dy=112;

              if (obj.startX == 1152 && obj.startY == 368){
                x = 960, y = 400, sign =-1;
              }else if (obj.startX == 960 && obj.startY == 400){
                x=1152, y = 368;
              }else if (obj.startX == 1488 && obj.startY == 720){
                x=1424, y = 112;
              }else if(obj.startX == 1424 && obj.startY == 112){
                x=1488, y = 720;
                dx = 240;
              }
              console.log(x,y);
              console.log("route");
              player.x = dx + sign*blocksize;
              player.y = dy + sign*blocksize;
              tileEngine.sx = x - 112;
              tileEngine.sy = y - 112;


            }else if(obj.type === 'princess' && obj.collidesWith(player)) {
              loop.stop();
              alert("Hurrayyy, you saved our dear princess:)");

            }else if (obj.type === 'switch' && obj.collidesWith(player)) {
                if (obj.count) {
                  obj.count--;
                } else {
                  obj.toggle();
                  var result = {toggle: function(){}}
                  if (obj.startX == 112 && obj.startY == 128)
                  result = sgate.objects.find(obj => {
                    return obj.startX === 80 && obj.startY == 112
                  })
                  else if (obj.startX == 432 && obj.startY == 144)
                    result = sgate.objects.find(obj => {
                      return obj.startX === 400 && obj.startY == 80
                    })
                  else if (obj.startX == 1520 && obj.startY == 736)
                    result = sgate.objects.find(obj => {
                      return obj.startX === 1072 && obj.startY == 592
                    })

                  result.toggle()
                  obj.count = 30;
                }
            } else if (obj.type === 'gate' && obj.collidesWith(player) && obj.way == 1) {
              player.y +=player.speed;
              return;
            } else if ((obj.type === 'gems' || obj.type == 'gold') && obj.collidesWith(player)) {
              var o = context.createOscillator()
              var  g = context.createGain()
              o.connect(g)
              var frequency = 261.6
              o.frequency.value = frequency
              g.connect(context.destination)
              if(muted == 0){
                o.start(0)
                o.stop(context.currentTime + .1)
              }

              obj.ttl = 0;
              if (obj.type == 'gold')
                playscore += 100;
              if (obj.type == 'gems')
                playscore += 200;
              stag.innerHTML = playscore;

            } else if ((obj.type == 'ghost' || obj.type == 'trap') && obj.collidesWith(player)) {
              player.playAnimation('dead');
              gameOver();
            }
          }
          player.update();

        if(muted == 0)
        if(frames == 0){
          v++;
          v%=17;
          notesGenerator.playNote(nextNote[v]);
          frames = 60;
        }else{
          frames--;
        }

        },
        render: function () {
          tileEngine.render();
          player.render();
          ghosts.render();
          lamps.render();
          traps.render();
          Switch.render();
          sgate.render();
          tsure.render();
          spider.render();
          princess.render();
          routes.render();

        }

      });


      window.gameOver = function () {
        loop.stop();
        stag.innerHTML = 0;
        state.innerHTML = "Game Over !";
      }

      loop.start();

       kontra.keys.bind('m', function() {
          muted = muted == 0 ? 1 : 0;
      });
    });
  </script>
</body>

</html>
