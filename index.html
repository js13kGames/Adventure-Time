<!DOCTYPE html>
<html>

<head>
  <title>Tile Engine</title>
  <style>
    * {
      margin: 0;
      border: 0;
    }

    body {
      background-color: black;
    }

    div#float {
      color: white;
      float: right;
      margin: 40px;
      font-size: 25px;
    }

    canvas {
      background: black;
      width: 1100px;
      height: 600px;

    }

    button {
      background-color: #4CAF50;
      /* Green */
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
    }

    #{
 color: #4CAF50;
    }
  </style>
  <script type="text/javascript" src="kontra.js"></script>
</head>

<body>

  <!-- <canvas width="352" height="180"></canvas> -->
  <canvas width="1600" height="800"></canvas>

  <div id="float">
    <div id="dis">Score:
      <span id="score">0</span>
    </div>
    <button id="button" style="display:none" onclick="startGame()">Restart</button>
    <div id="state">Game Started</div>
  </div>
  <script id="code">
    kontra.init();
    var playscore = 0, stag = document.getElementById('score'), button = document.getElementById('button'), state = document.getElementById('state');


    kontra.assets.imagePath = 'assets/';
    kontra.assets.dataPath = 'assets/';
    function startGame() {
      location.reload();
    };
    setTimeout(function () {
      state.innerHTML = "";
      document.getElementById('button').style.display = "inline-block";
    }, 2000);

    kontra.assets.load('terrain.json', 'man.png', 'new.png').then(function () {
      var terrain = kontra.assets.data.terrain;
      var quadtree = kontra.quadtree();
      tileEngine = kontra.tileEngine(kontra.assets.data.terrain);
      tileEngine.sx = 0,
        tileEngine.sy = 0

      var tsure = kontra.pool({
        create: kontra.sprite,
        maxSize: 57
      });
      var tsure_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gold: {
            frames: [90],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gems: {
            frames: [91],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnTsure() {
        var arry = [16, 32, 32, 32, 64, 64, 64, 80, 80, 80, 112, 128, 128, 128, 128, 144, 144, 144, 160, 160, 208, 224, 224, 240, 256, 256, 352, 368, 368, 400, 448, 448, 464, 480, 480, 496, 496, 496, 496, 496, 528, 544, 544, 576, 576, 592, 688, 688, 704, 704, 704, 720, 720, 736, 736, 752, 752];
        var arrx = [416, 352, 368, 448, 64, 80, 96, 64, 80, 96, 1152, 496, 512, 528, 1168, 512, 528, 1152, 528, 1168, 336, 304, 384, 352, 304, 368, 1120, 1008, 1040, 1104, 1008, 1072, 976, 1040, 1056, 608, 688, 1024, 1072, 1088, 640, 608, 672, 608, 640, 672, 944, 1024, 336, 416, 976, 400, 1008, 368, 960, 960, 992];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          var type = ['gold', 'gems'];
          var type = type[Math.floor(Math.random() * 2)]
          console.log(type);
          tsure.get(function (types) {
            return {
              x: x,
              y: y,
              startX: x,
              startY: y,
              animations: tsure_animation.animations,
              ttl: Infinity,
              type: types,
              way: 1,
              update: function () {
                if (this.way == 1) {
                  this.playAnimation(types)
                  this.way = 0
                }
                this.x = this.startX - tileEngine.sx;
                this.y = this.startY - tileEngine.sy;
              }
            }
          }(type));
        }
      }
      spawnTsure();

      var Switch = kontra.pool({
        create: kontra.sprite,
        maxSize: 3
      });
      var switch_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gate_open: {
            frames: [100, 101, 102],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gate_close: {
            frames: [102, 101, 100],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          no_motion: {
            frames: [100],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnswitch() {
        var arry = [128, 144, 736];
        var arrx = [112, 432, 1520];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          Switch.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: switch_animation.animations,
            ttl: Infinity,
            count: 30,
            way: 1,
            start: 1,
            type: 'switch',
            toggle: function () {
              if (this.way) {
                this.playAnimation('gate_open')
                this.way = 0
              } else {
                this.playAnimation('gate_close')
                this.way = 1
              }
            },
            update: function () {
              this.advance();
              if (this.start) {
                this.playAnimation('no_motion')
                this.start = 0
              }
              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnswitch();

      var sgate = kontra.pool({
        create: kontra.sprite,
        maxSize: 2
      });

      var sgate_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          gate_open: {
            frames: [48, 93, 9, 59],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          gate_close: {
            frames: [59, 9, 93, 48],  // frames 105 through 112
            frameRate: 3,
            loop: false
          },
          no_motion: {
            frames: [48],  // frames 105 through 112
            frameRate: 3,
            loop: false
          }
        }
      });

      function spawnsGate() {
        var arry = [112, 592, 80];
        var arrx = [80, 1072, 400];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          sgate.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            way: 1,
            start: 1,
            animations: sgate_animation.animations,
            ttl: Infinity,
            type: 'gate',
            toggle: function () {
              if (this.way) {
                this.playAnimation('gate_open')
                this.way = 0
              } else {
                this.playAnimation('gate_close')
                this.way = 1
              }
            },
            update: function () {
              this.advance();
              if (this.start) {
                this.playAnimation('no_motion')
                this.start = 0
              }
              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnsGate();

      var lamps = kontra.pool({
        create: kontra.sprite,
        maxSize: 49
      });

      var lamp_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          default: {
            frames: [107, 108, 109],  // frames 105 through 112
            frameRate: 6
          }
        }
      });

      function spawnLamp() {
        var arry = [48, 48, 96, 96, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 336, 352, 352, 352, 368, 384, 384, 400, 416, 416, 416, 416, 432, 432, 448, 448, 464, 464, 480, 480, 496, 496, 512, 512, 528, 528, 544, 544, 544, 544, 544, 544, 544, 544];
        var arrx = [48, 112, 48, 112, 976, 992, 1008, 1024, 1040, 1056, 1072, 1088, 1104, 1120, 1136, 1152, 960, 976, 1152, 960, 960, 1152, 1152, 960, 1120, 1136, 1152, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 1120, 960, 976, 992, 1008, 1024, 1040, 1104, 1120];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          lamps.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: lamp_animation.animations,
            ttl: Infinity,
            type: 'lamp',
            update: function () {
              this.advance();

              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnLamp();

      var traps = kontra.pool({
        create: kontra.sprite,
        maxSize: 30
      });

      var trap_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          pattern1: {
            frames: [103, 104, 105],  // frames 105 through 112
            frameRate: 2
          },
          pattern0: {
            frames: [104, 105, 103],  // frames 105 through 112
            frameRate: 2
          }
        }
      });

      function spawnTrap() {
        var arry = [320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 320, 336, 336, 336, 352, 352, 368, 560, 560, 560, 576, 576, 576, 592, 592, 592, 592];
        var arrx = [960, 976, 992, 1008, 1024, 1040, 1056, 1072, 1088, 1104, 1120, 1136, 1152, 1168, 944, 960, 1168, 944, 1168, 944, 1024, 1040, 1120, 1040, 1104, 1120, 1040, 1056, 1088, 1104];
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          traps.get({
            x: x,
            y: y,
            startX: x,
            startY: y,
            animations: trap_animation.animations,
            ttl: Infinity,
            type: 'trap',
            update: function () {
              this.advance();
              // (function (self,name_){
              //   self.playAnimation(name_)
              // })(this, 'pattern' + Math.floor(Math.random()*2 ))
              // change enemy velocity to move back and forth
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
            },
          });
        }
      }
      spawnTrap();

      var spider = kontra.pool({
        create: kontra.sprite,
        maxSize: 5
      });


      var spider_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_down: {
            frames: [61, 62, 63],  // frames 105 through 112
            frameRate: 12
          },
          walk_right: {
            frames: [46, 47, 49],
            frameRate: 12
          },
          walk_left: {
            frames: [17,27,37],
            frameRate: 12
          },
          walk_up: {
            frames: [81,82,83],
            frameRate: 12
          }
        }
      });

      function spawnSpider() {
        var arrY = [512, 576, 704, 768, 768];
        var arrX = [304, 416, 768, 688, 800];
        for (var i in arrX) {
          var x = arrX[i], y = arrY[i];
          spider.get({
            x: x,
            y: y,
            Y: 0,
            startX: x,
            startY: y,
            animations: spider_animation.animations,
            ttl: Infinity,
            bottomEdge: 32 + 16,
            topEdge: -32,
            speedy: .5,
            type: 'ghost',
            update: function () {
              this.advance();
              this.Y += this.speedy;
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY + this.Y - tileEngine.sy;
              if (this.Y <= this.topEdge) {
                this.speedy = Math.abs(this.speedy);
              }
              else if (this.Y >= this.bottomEdge) {
                this.speedy = -Math.abs(this.speedy);
              }
              if (this.speedy > 0) {
                this.playAnimation('walk_down')
              } else if (this.speedy < 0) {
                this.playAnimation('walk_up')
              }
            },
          });
        }
      }
      spawnSpider();

      var ghosts = kontra.pool({
        create: kontra.sprite,
        maxSize: 16
      });


      var ghost_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_up: {
            frames: [80, 77, 67],  // frames 105 through 112
            frameRate: 12
          },
          walk_left: {
            frames: [16, 26, 36],
            frameRate: 12
          },
          walk_down: {
            frames: [60, 55, 45],
            frameRate: 12
          },
          walk_right: {
            frames: [7, 0, 75],
            frameRate: 12
          }
        }
      });

      function spawnGhost() {
        var arry = [160, 192, 208, 224, 320, 368];
        var arrx = [384, 1424, 80, 1168, 288, 80];
        var arrY = [400, 496, 496, 512, 512, 560, 560, 560, 672, 720];
        var arrX = [32, 800, 832, 240, 448, 272, 784, 816, 1120, 896];

        // var funarr = [horver,]
        for (var i in arrx) {
          var x = arrx[i], y = arry[i];
          ghosts.get({
            x: x,
            y: y,
            X: 0,
            startX: x,
            startY: y,
            animations: ghost_animation.animations,
            ttl: Infinity,
            leftEdge: -32,
            rightEdge: 32 + 16,
            speedx: .5,
            type: 'ghost',
            update: function () {
              this.advance();

              this.X += this.speedx;
              this.x = this.startX + this.X - tileEngine.sx;
              this.y = this.startY - tileEngine.sy;
              if (this.X <= this.leftEdge) {
                this.speedx = Math.abs(this.speedx);
              }
              else if (this.X >= this.rightEdge) {
                this.speedx = -Math.abs(this.speedx);
              }
              if (this.speedx > 0) {
                this.playAnimation('walk_right')
              } else if (this.speedx < 0) {
                this.playAnimation('walk_left')
              }
            },
          });
        }
        for (var i in arrX) {
          var x = arrX[i], y = arrY[i];
          ghosts.get({
            x: x,
            y: y,
            Y: 0,
            startX: x,
            startY: y,
            animations: ghost_animation.animations,
            ttl: Infinity,
            bottomEdge: 32 + 16,
            topEdge: -32,
            speedy: .5,
            type: 'ghost',
            update: function () {
              this.advance();
              this.Y += this.speedy;
              this.x = this.startX - tileEngine.sx;
              this.y = this.startY + this.Y - tileEngine.sy;
              if (this.Y <= this.topEdge) {
                this.speedy = Math.abs(this.speedy);
              }
              else if (this.Y >= this.bottomEdge) {
                this.speedy = -Math.abs(this.speedy);
              }
              if (this.speedy > 0) {
                this.playAnimation('walk_down')
              } else if (this.speedy < 0) {
                this.playAnimation('walk_up')
              }
            },
          });
        }
      }


      // create the walking man sprite sheet and animations
      var player_animation = kontra.spriteSheet({
        image: kontra.assets.images.new,
        frameWidth: 16,
        frameHeight: 16,
        animations: {
          walk_up: {
            frames: [44, 34, 24],  // frames 105 through 112
            frameRate: 12
          },
          walk_left: {
            frames: [2, 12, 22],
            frameRate: 12
          },
          walk_down: {
            frames: [10, 76, 1],
            frameRate: 12
          },
          walk_right: {
            frames: [33, 40, 41],
            frameRate: 12
          },
          dead: {
            frames: [11],
            frameRate: 12
          }
        }
      });

      // create the player
      player = kontra.sprite({
        x: 176,
        y: 88,
        speed: 1,
        startX: 176,
        startY: 88,
        animations: player_animation.animations,
        update: function () {
          // create a smaller bounding box for the player's collision
          var collisionBox = {
            y: this.y + 4,
            x: this.x + 2,
            width: 10,
            height: 10
          };

          if (kontra.keys.pressed('up')) {
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }
            // change the animation
            this.playAnimation('walk_up');

            // update the animation
            this.advance();

            // don't move the player if he collides with the collision layer
            collisionBox.y -= this.speed;

            // player will walk in the center of the map so long as he doesn't
            // reach the edge
            if (tileEngine.sy > 0 && this.y <= this.startY) {
              tileEngine.sy -= this.speed;
            }
            // otherwise the map will stop moving and the player will move from
            // the center
            else {
              this.y -= this.speed;
            }
          }

          else if (kontra.keys.pressed('down')) {
            this.playAnimation('walk_down');

            this.advance();

            collisionBox.y += this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }
            if (tileEngine.sy < tileEngine.mapHeight - kontra.canvas.height &&
              this.y >= this.startY) {
              tileEngine.sy += this.speed;
            }
            else {
              this.y += this.speed;
            }
          }

          else if (kontra.keys.pressed('left')) {
            this.playAnimation('walk_left');

            this.advance();

            collisionBox.x -= this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }

            if (tileEngine.sx > 0 && this.x <= this.startX) {
              tileEngine.sx -= this.speed;
            }
            else {
              this.x -= this.speed;
            }
          }

          else if (kontra.keys.pressed('right')) {
            this.playAnimation('walk_right');

            this.advance();

            collisionBox.x += this.speed;
            if (tileEngine.layerCollidesWith('top', collisionBox)) {
              return;
            }

            if (tileEngine.sx < tileEngine.mapWidth - kontra.canvas.width &&
              this.x >= this.startX) {
              tileEngine.sx += this.speed;
            }
            else {
              this.x += this.speed;
            }
          }
        },
      });
      // clamp player position in the game world
      player.position.clamp(0, 0, kontra.canvas.width - player.width, kontra.canvas.height - player.height);

      var loop = kontra.gameLoop({
        update: function () {
          ghosts.update();
          lamps.update();
          traps.update();
          Switch.update();
          sgate.update();
          tsure.update();
          spider.update();
          if (ghosts.getAliveObjects().length === 0) {
            spawnGhost();
          }
          quadtree.clear();
          quadtree.add(Switch.getAliveObjects(), sgate.getAliveObjects(), tsure.getAliveObjects(), ghosts.getAliveObjects(), spider.getAliveObjects(), traps.getAliveObjects());
          var objects = quadtree.get(player);
          player.update();

          for (var i = 0, obj; obj = objects[i]; i++) {
            if (obj.type === 'switch' && obj.collidesWith(player)) {
              if (obj.startX == 112 && obj.startY == 128) {
                if (obj.count) {
                  obj.count--;
                } else {
                  obj.toggle();
                  var result = sgate.objects.find(obj => {
                    return obj.startX === 80 && obj.startY == 112
                  })
                  result.toggle()
                  obj.count = 30;
                }
              }
            } else if (obj.type === 'gate' && obj.collidesWith(player) && obj.way == 0) {
              // console.log(obj)
              return;
            } else if ((obj.type === 'gems' || obj.type == 'gold') && obj.collidesWith(player)) {

              obj.ttl = 0;
              if (obj.type == 'gold')
                playscore += 100;
              if (obj.type == 'gems')
                playscore += 200;
              stag.innerHTML = playscore;
            }else if(obj.type = 'ghost' && obj.collidesWith(player)){
              player.playAnimation('dead');
              gameOver();
            }
          }
        },
        render: function () {
          tileEngine.render();
          player.render();
          ghosts.render();
          lamps.render();
          traps.render();
          Switch.render();
          sgate.render();
          tsure.render();
          spider.render();
        }

      });


      window.gameOver = function () {
        loop.stop();
        stag.innerHTML = 0;
        state.innerHTML = "Game Over !";
      }

      loop.start();
    });
  </script>
</body>

</html>
